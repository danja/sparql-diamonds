<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Bookmarks</title>

    <link rel="stylesheet" href="../css/bookmarks.css" />

    <script src="../lib/jquery-3.6.0.min.js"></script>

    <!-- template engine -->
    <script src="../lib/hogan-3.0.2.js"></script>

    <!-- time format utils -->
    <script src="../lib/moment.js"></script>

    <script src="../js/config.js"></script>

    <script src="../js/utils.js"></script>
    <script src="../js/sparql-connector.js"></script>

    <script src="../sparql-templates/bookmarks-common.js"></script>
    <script src="../sparql-templates/bookmark-insert.js"></script>

    <script src="../html-templates/bookmarks-template.js"></script>
    <!-- script src="../html-templates/link-template.js"></script -->

    <script type="text/javascript" language="javascript">
      function makeList (bookmarks) {
        var keys = Object.keys(bookmarks)

        var list = '<ul>'

        for (var i = 0; i < keys.length; i++) {
          console.log('bookmarks[i] = ' + JSON.stringify(bookmarks[keys[i]]))
          list += templater(listBookmarksTemplate, bookmarks[keys[i]])
        }
        return list + '</ul>'
      }

      // three ways of handling : the ID, single values, multiple values

      function resultsHandler (json) {
        // console.log('RESULT = ' + JSON.stringify(json))
        //        console.log('RESULTS = ' + JSON.stringify(json['results']['bindings']))
        var bindings = json['results']['bindings']

        var bookmarks = {}
        var currentBookmarkData

        for (var i = 0; i < bindings.length; i++) {
          // effectively the ID field
          var bookmarkURI = bindings[i]['bookmark']['value']

          if (!(bookmarkURI in bookmarks)) {
            currentBookmarkData = {}
            bookmarks[bookmarkURI] = currentBookmarkData
          }

          var keys = Object.keys(bindings[i])

          for (var j = 0; j < keys.length; j++) {
            var key = keys[j]
            if (key != 'bookmark') {
              var value = bindings[i][key]['value']
              //  console.log('value = '+JSON.stringify(value))
              var values = currentBookmarkData[key]
              if (!values) {
                values = []
              }
              if (!values.includes(value)) {
                // (value in values)
                values.push(value)
              }
              currentBookmarkData[key] = values
            }
          }
        }
        console.log('bookmarks = ' + JSON.stringify(bookmarks))
        var list = makeList(bookmarks)

        $('#bookmarks').replaceWith(list)
      }

      function listBookmarks () {
        // template on ORDER?

        // templater(wikidataNameTemplate, dict)

        var url =
          SparqlServer.host +
          SparqlServer.queryPath +
          '?query=' +
          encodeURIComponent(listBookmarksSparqlTemplate) +
          '&output=json'

        doQuery(url, resultsHandler)
      }

      function doSubmit () { // SPECIAL CASE TAGS? CREATED

        // extract data from form
        // default, starting point is { id: 'value'}
        var bookmarkData = {};
        $('#fields :input').each(function (index, field) {
          //element is the specific field:
          bookmarkData[$(field).attr('id')] =  $(field).val();
        //  console.log($(field).attr('id'))
        //  console.log($(field).val())
        });

        // generate a URI for the bookmark
        bookmarkData['bookmark'] =  bookmarkBaseURI + hashCode(bookmarkData['url']);

        bookmarkData['created'] = (new Date()).toISOString();
        console.log(JSON.stringify(bookmarkData));
        var addBookmarkSparql = templater(addBookmarkSparqlTemplate, bookmarkData);

        console.log(addBookmarkSparql)

        var url = SparqlServer.host + SparqlServer.updatePath;

        doInsert(url, addBookmarkSparql);
      }

      $(document).ready(function () {
        $('#submit-button').click(function () {
          console.log($('#add-bookmark').val())
          doSubmit($('#add-bookmark').val())
        })
        listBookmarks();
      })
    </script>
  </head>

  <body>
    <h2>Bookmarks</h2>

    <p id="bookmarks"></p>

    <form id="add-bookmark">
      <fieldset id="fields">
        <legend>Add Bookmark</legend>
        <label for="url">Link</label>
        <input id="url" type="text" value="http://hyperdata.it/bookmarks/b3" />
        <label for="title">Title</label>
        <input id="title" type="text" value="b3" />
        <label for="description">Description</label>
        <textarea class="description" id="description">this is b3</textarea>
        <label for="tags">Tags</label>
        <input id="tags" type="text" value="tag1, tag2"/>
        <label for="nick">Creator</label>
        <input id="nick" type="text" value="danja"/>
      </fieldset>
      <button type="button" id="submit-button">Submit</button>
    </form>
  </body>
</html>
